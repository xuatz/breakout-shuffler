# Docker Compose override for Tailscale testing
#
# Uses Tailscale sidecar containers to expose services on the Tailscale network.
# Each service gets its own hostname: breakout-client.<tailnet>.ts.net, breakout-server.<tailnet>.ts.net
#
# Prerequisites:
#   1. Generate a reusable auth key at https://login.tailscale.com/admin/settings/keys
#   2. Add to .env file: TS_AUTHKEY=tskey-auth-xxxxx
#
# Usage:
#   ./scripts/run-docker-tailscale.sh

services:
  # Disable caddy - Tailscale handles HTTPS
  caddy:
    profiles:
      - disabled

  # Tailscale sidecar for client
  ts-client:
    image: tailscale/tailscale:latest
    hostname: breakout-client
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_HOSTNAME=breakout-client
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_SERVE_CONFIG=/config/serve.json
      - TS_USERSPACE=false
    volumes:
      - ts-client-state:/var/lib/tailscale
      - ./tailscale/client-serve.json:/config/serve.json:ro
    cap_add:
      - net_admin
      - sys_module
    devices:
      - /dev/net/tun:/dev/net/tun
    restart: unless-stopped

  # Tailscale sidecar for server
  ts-server:
    image: tailscale/tailscale:latest
    hostname: breakout-server
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_HOSTNAME=breakout-server
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_SERVE_CONFIG=/config/serve.json
      - TS_USERSPACE=false
    volumes:
      - ts-server-state:/var/lib/tailscale
      - ./tailscale/server-serve.json:/config/serve.json:ro
    cap_add:
      - net_admin
      - sys_module
    devices:
      - /dev/net/tun:/dev/net/tun
    restart: unless-stopped

  # Override client to use Tailscale network
  client:
    network_mode: service:ts-client
    depends_on:
      - ts-client
    environment:
      - VITE_PUBLIC_URL=https://breakout-client.${TAILSCALE_DOMAIN}
      - VITE_API_URL=https://breakout-server.${TAILSCALE_DOMAIN}
      - VITE_COOKIE_DOMAIN=.${TAILSCALE_DOMAIN}

  # Override server to use Tailscale network
  server:
    network_mode: service:ts-server
    depends_on:
      - ts-server
    environment:
      - CORS_ORIGINS=https://breakout-client.${TAILSCALE_DOMAIN}

volumes:
  ts-client-state:
  ts-server-state:
